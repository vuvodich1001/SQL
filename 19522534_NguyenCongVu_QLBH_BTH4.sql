-- TAO DATABASE QLBH
CREATE DATABASE QLBH
GO
USE QLBH
-- TAO CAC BANG
CREATE TABLE KHACHHANG(
	MAKH CHAR(4) NOT NULL,
	HOTEN VARCHAR(40),
	DIACHI VARCHAR(50),
	SODT VARCHAR(20),
	NGSINH SMALLDATETIME,
	NGDK SMALLDATETIME,
	DOANHSO MONEY,
)

CREATE TABLE NHANVIEN(
	MANV CHAR(4) NOT NULL,
	HOTEN VARCHAR(40),
	SODT VARCHAR(20) NOT NULL,
	NGAYVL SMALLDATETIME,
)

CREATE TABLE SANPHAM(
	MASP CHAR(4) NOT NULL,
	TENSP VARCHAR(40),
	DVT VARCHAR(20),
	NUOCSX VARCHAR(40),
	GIA MONEY,
)
CREATE TABLE HOADON(
	SOHD INT NOT NULL,
	NGMH SMALLDATETIME,
	MAKH CHAR(4),
	MANV CHAR(4),
	TRIGIA MONEY,
)
CREATE TABLE CTHD(
	SOHD INT NOT NULL,
	MASP CHAR(4) NOT NULL,
	SL INT,
)
-- PHAN 1
--CAU 1
--TAO KHOA CHINH
ALTER TABLE KHACHHANG
ADD CONSTRAINT PK_KHACHHANG
PRIMARY KEY(MAKH)

ALTER TABLE NHANVIEN
ADD CONSTRAINT PK_NHANVIEN
PRIMARY KEY(MANV)

ALTER TABLE SANPHAM
ADD CONSTRAINT PK_SANPHAM
PRIMARY KEY(MASP)

ALTER TABLE HOADON
ADD CONSTRAINT PK_HOADON
PRIMARY KEY(SOHD)

ALTER TABLE CTHD
ADD CONSTRAINT PK_CTHD
PRIMARY KEY(SOHD, MASP)

-- TAO KHOA NGOAI
ALTER TABLE HOADON
ADD CONSTRAINT FK_HOADON_MAKH
FOREIGN KEY (MAKH) REFERENCES KHACHHANG(MAKH)

ALTER TABLE HOADON
ADD CONSTRAINT FK_HOADON_MANV
FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

ALTER TABLE CTHD
ADD CONSTRAINT FK_CTHD_MASP
FOREIGN KEY (MASP) REFERENCES SANPHAM(MASP)

ALTER TABLE CTHD
ADD CONSTRAINT FK_CTHD_SOHD
FOREIGN KEY (SOHD) REFERENCES HOADON(SOHD)

-- CAU 2
ALTER TABLE SANPHAM
ADD GHICHU VARCHAR(20)
-- CAU 3
ALTER TABLE KHACHHANG
ADD LOAIKH TINYINT
-- CAU 4
ALTER TABLE SANPHAM
ALTER COLUMN GHICHU VARCHAR(100)
-- CAU 5
ALTER TABLE SANPHAM
DROP COLUMN GHICHU
-- CAU 6
ALTER TABLE KHACHHANG
ALTER COLUMN LOAIKH VARCHAR(20)

ALTER TABLE KHACHHANG
ADD CONSTRAINT CHK_KHACHHANG_LOAIKH
CHECK (LOAIKH IN ('vang lai', 'vip', 'thuong'))

-- CAU 7
ALTER TABLE SANPHAM
ADD CONSTRAINT CHK_SANPHAM_DVT
CHECK (DVT IN ('cay', 'hop', 'cai', 'quyen', 'chuc'))
-- CAU 8
ALTER TABLE SANPHAM
ADD CONSTRAINT CHK_SANPHAM_GIA
CHECK (GIA > 500)
-- CAU 9
ALTER TABLE CTHD
ADD CONSTRAINT CHK_SANPHAM_SL
CHECK (SL >= 1)

-- CAU 10
ALTER TABLE KHACHHANG
ADD CONSTRAINT CHK_KHACHHANG_NGAYDK
CHECK (NGDK > NGSINH)
----------------------------------BAT DAU BAI TH5--------------------------------------
/*Nen insert vao sql theo tung dong*/
-- CAU 11
-- C1
CREATE TRIGGER TRG_NGDK_NGMH ON HOADON
FOR INSERT, UPDATE
AS 
BEGIN
	DECLARE @MAKH CHAR(4), @NGMH SMALLDATETIME, @NGDK SMALLDATETIME
	SELECT @NGMH = NGMH, @MAKH = MAKH FROM INSERTED
	SELECT @NGDK = NGDK FROM KHACHHANG WHERE MAKH = @MAKH
	IF @NGDK > @NGMH
	BEGIN
		PRINT 'LOI! KHONG HOP LE'
		ROLLBACK TRAN	
	END
	ELSE
	BEGIN
		PRINT 'THANH CONG!'	
	END
END

-- C2 TRIGGER THEM, XOA
CREATE TRIGGER  TRG_INS_NGMH ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	IF EXISTS (SELECT COUNT(*) FROM KHACHHANG KH INNER JOIN  INSERTED I ON KH.MAKH = I.MAKH
	WHERE I.NGMH > KH.NGDK)
		BEGIN
			PRINT 'THANH CONG'
		END
	ELSE
		BEGIN
			PRINT 'LOI! KHONG HOP LE'
			ROLLBACK TRAN
		END
END

-- CAU 12
-- C1
CREATE TRIGGER TRG_NGVL_NGBH ON HOADON
FOR INSERT, UPDATE
AS 
BEGIN
	DECLARE @NGVL SMALLDATETIME, @NGBH SMALLDATETIME, @MANV CHAR(4)
	SELECT @NGBH = NGMH, @MANV = MANV FROM INSERTED
	SELECT @NGVL = NGAYVL FROM NHANVIEN WHERE MANV = @MANV
	IF @NGBH >= @NGVL
	BEGIN
		PRINT 'THANH CONG!'
	END
	ELSE
	BEGIN
		PRINT 'LOI! KHONG HOP LE'
		ROLLBACK TRAN
	END
END
-- C2 TRIGGER THEM, XOA
CREATE TRIGGER TRG_INS_HD ON HOADON
FOR INSERT, UPDATE
AS 
BEGIN
	IF EXISTS (SELECT * FROM INSERTED I INNER JOIN KHACHHANG KH ON I.MAKH = KH.MAKH 
	WHERE I.NGMH < KH.NGDK)
		BEGIN
			PRINT 'THANH CONG'
		END
	ELSE
		BEGIN
			RAISERROR('LOI! KHONG HOP LE', 16, 1)
			ROLLBACK TRAN
		END
END

-- CAU 13
-- C1
CREATE TRIGGER TRG_SLCTHD ON HOADON
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @SOHD CHAR(4), @SLHD INT
	SELECT @SOHD = SOHD FROM INSERTED
	SELECT @SLHD = COUNT(*) FROM CTHD WHERE SOHD = @SOHD
	IF @SLHD >= 1
	BEGIN
		PRINT 'THANH CONG!'
	END
	ELSE
	BEGIN
		PRINT 'LOI! KHONG HOP LE'
		ROLLBACK TRAN
	END
END
-- C2
-- TRIGGER THEM
CREATE TRIGGER TRG_INS_SLCTHD ON HOADON
FOR INSERT
AS
BEGIN
	IF ((SELECT COUNT(*) FROM INSERTED I INNER JOIN CTHD C ON I.SOHD = C.SOHD) >= 1)
		BEGIN
			PRINT 'THANH CONG'
		END
	ELSE
		BEGIN
			PRINT 'LOI! KHONG HOP LE'
			ROLLBACK TRAN
		END
END

-- TRIGGER XOA
CREATE TRIGGER TRG_DEL_SLCTHD ON HOADON
FOR DELETE
AS
BEGIN
	IF ((SELECT COUNT(*) FROM DELETED D INNER JOIN CTHD C ON D.SOHD = C.SOHD) >= 1)
		BEGIN
			PRINT 'BAN DA XOA THANH CONG'
		END
	ELSE
		BEGIN
			PRINT 'LOI! KHONG HOP LE'
			ROLLBACK TRAN
		END
END


-- CAU 14
CREATE TRIGGER TRG_TRIGIA ON HOADON FOR INSERT, UPDATE
AS 
BEGIN
	DECLARE @SOHD CHAR(4), @TRIGIA MONEY, @MASP CHAR(4), @SL INT
	SELECT @SOHD = SOHD FROM INSERTED
	SET @TRIGIA = 0
	DECLARE CUR_CTHD CURSOR FOR SELECT MASP, SL FROM CTHD WHERE SOHD = @SOHD
	OPEN CUR_CTHHD	
	FETCH NEXT FROM CUR_CTHD INTO @MASP, @SL
	WHILE(@@FETCH_STATUS = 0)
		BEGIN
			SET @TRIGIA += @SL * (SELECT GIA FROM SANPHAM WHERE MASP = @MASP)
			FETCH NEXT FROM CUR_CTHD INTO @MASP, @SL	
		END
	CLOSE CUR_CTHD
	DEALLOCATE CUR_CTHD
	UPDATE HOADON SET TRIGIA = @TRIGIA WHERE SOHD = @SOHD
END

-- CAU 15
CREATE TRIGGER TRG_DOANHSO ON KHACHHANG
FOR INSERT, UPDATE
AS
BEGIN
	DECLARE @MAKH CHAR(4), @TRIGIA MONEY, @DOANHSO MONEY
	SELECT @MAKH = MAKH FROM INSERTED
	SET @DOANHSO = 0
	DECLARE CUR_HOADON CURSOR FOR SELECT TRIGIA FROM HOADON WHERE MAKH = @MAKH
	OPEN CUR_HOADON
	FETCH NEXT FROM CUR_HODON INTO @TRIGIA
	WHILE (@@FETCH_STATUS = 0)
		BEGIN
			SET @DOANHSO += @TRIGIA
			FETCH NEXT FROM CUR_HOADON INTO @TRIGIA	
		END
	CLOSE CUR_HOADON
	DEALLOCATE CUR_HOADON
	UPDATE KHACHHANG SET DOANHSO = @TRIGIA WHERE MAKH = @MAKH
END

----------------------------------KET THUC BAI TH5--------------------------------------
-- PHAN 2
-- CAU 1
-- NHAP DU LIEU VAO TABLE NHANVIEN
INSERT INTO NHANVIEN(MANV, HOTEN, SODT, NGAYVL)
VALUES ('NV01', 'Nguyen Nhu Nhut', '0927345678', '13/04/2006'),
	('NV02', 'Le Thi Phi Yen', '0987567390', '21/04/2006'),
	('NV03', 'Nguyen Van B', '0997047382', '27/04/2006'),
	('NV04', 'Ngo Thanh Tuan', '0913758498', '24/06/2006'),
	('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '20/07/2006')

-- Nhap du lieu vao table KhachHang
INSERT INTO KhachHang(MaKH, HoTen, DiaChi, SoDT, NgSinh, NgDK, DoanhSo)
VALUES ('KH01', 'Nguyen Van A', '731 Tran Hung Dao, Q5, TpHCM', '8823451', '22/10/1960', '22/07/2006', '13060000'),
	('KH02', 'Tran Ngoc Han', '23/5 Nguyen Trai, Q5, TpHCM', '908256478', '03/04/1974', '30/07/2006', '280000'),
	('KH03', 'Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, TpHCM', '938776266', '12/06/1980', '05/08/2006', '3860000'),
	('KH04', 'Tran Minh Long', '50/34 Le Dai Hanh, Q10, TpHCM', '917325476', '09/03/1965', '02/10/2006', '250000'),
	('KH05', 'Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM', '8246108', '10/03/1950', '28/10/2006', '21000'),
	('KH06', 'Le Hoai Thuong', '227 Nguyen Van Cu, Q5, TpHCM', '8631738', '31/12/1981', '24/11/2006', '915000'),
	('KH07', 'Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, TpHCM', '916783565', '06/04/1971', '01/12/2006', '12500'),
	('KH08', 'Phan Thi Thanh', '45/2 An Duong Vuong, Q5, TpHCM', '938435756', '10/01/1971', '13/12/2006', '365000'),
	('KH09', 'Le Ha Vinh', '873 Le Hong Phong, Q5, TpHCM', '8654763', '03/09/1979', '14/01/2007', '70000'),
	('KH10', 'Ha Duy Lap', '34/34B Nguyen Trai, Q1, TpHCM', '8768904', '02/05/1983', '16/01/2007', '67500')

-- Nhap du lieu vao table HoaDon
INSERT INTO HOADON(SOHD, NGMH, MAKH, MANV, TRIGIA)
VALUES ('1001', '23/07/2006', 'KH01', 'NV01', '320000'),
	('1002', '12/08/2006', 'KH01', 'NV02', '840000'),
	('1003', '23/08/2006', 'KH02', 'NV01', '100000'),
	('1004', '01/09/2006', 'KH02', 'NV01', '180000'),
	('1005', '20/10/2006', 'KH01', 'NV02', '3800000'),
	('1006', '16/10/2006', 'KH01', 'NV03', '2430000'),
	('1007', '28/10/2006', 'KH03', 'NV03', '510000'),
	('1008', '28/10/2006', 'KH01', 'NV03', '440000'),
	('1009', '28/10/2006', 'KH03', 'NV04', '200000'),
	('1010', '01/11/2006', 'KH01', 'NV01', '5200000'),
	('1011', '04/11/2006', 'KH04', 'NV03', '250000'),
	('1012', '30/11/2006', 'KH05', 'NV03', '21000'),
	('1013', '12/12/2006', 'KH06', 'NV01', '5000'),
	('1014', '31/12/2006', 'KH03', 'NV02', '3150000'),
	('1015', '01/01/2007', 'KH06', 'NV01', '910000'),
	('1016', '01/01/2007', 'KH07', 'NV02', '12500'),
	('1017', '02/01/2007', 'KH08', 'NV03', '35000'),
	('1018', '13/01/2007', 'KH08', 'NV03', '330000'),
	('1019', '13/01/2007', 'KH01', 'NV03', '30000'),
	('1020', '14/01/2007', 'KH09', 'NV04', '70000'),
	('1021', '16/01/2007', 'KH10', 'NV03', '67500'),
	('1022', '16/01/2007', 'KH01', 'NV03', '7000'),
	('1023', '17/01/2007', 'KH02', 'NV01', '330000')

-- Nhap du lieu vao table SanPham
INSERT INTO SANPHAM(MASP, TENSP, DVT, NUOCSX, GIA)
VALUES ('BC01', 'But chi', 'cay', 'Singapore', '3000'),
	('BC02', 'But chi', 'cay', 'Singapore', '5000'),
	('BC03', 'But chi', 'cay', 'Viet Nam', '3500'),
	('BC04', 'But chi', 'hop', 'Viet Nam', '30000'),
	('BB01', 'But bi', 'cay', 'Viet Nam', '5000'),
	('BB02', 'But bi', 'cay', 'Trung Quoc', '7000'),
	('BB03', 'But bi', 'hop', 'Thai Lan', '100000'),
	('TV01', 'Tap 100 giay mong', 'quyen', 'Trung Quoc', '2500'),
	('TV02', 'Tap 200 giay mong', 'quyen', 'Trung Quoc', '4500'),
	('TV03', 'Tap 100 giay tot', 'quyen', 'Viet Nam', '3000'),
	('TV04', 'Tap 200 giay tot', 'quyen', 'Viet Nam', '5500'),
	('TV05', 'Tap 100 trang', 'chuc', 'Viet Nam', '23000'),
	('TV06', 'Tap 200 trang', 'chuc', 'Viet Nam', '53000'),
	('TV07', 'Tap 100 trang', 'chuc', 'Trung Quoc', '34000'),
	('ST01', 'So tay 500 trang', 'quyen', 'Trung Quoc', '40000'),
	('ST02', 'So tay loai 1', 'quyen', 'Viet Nam', '55000'),
	('ST03', 'So tay loai 2', 'quyen', 'Viet Nam', '51000'),
	('ST04', 'So tay', 'quyen', 'Thai Lan', '55000'),
	('ST05', 'So tay mong', 'quyen', 'Thai Lan', '20000'),
	('ST06', 'Phan viet bang', 'hop', 'Viet Nam', '5000'),
	('ST07', 'Phan khong bui', 'hop', 'Viet Nam', '7000'),
	('ST08', 'Bong bang', 'cai', 'Viet Nam', '1000'),
	('ST09', 'But long', 'cay', 'Viet Nam', '5000'),
	('ST10', 'But long', 'cay', 'Trung Quoc', '7000')

-- Nhap du lieu vao table CTHD 
INSERT INTO CTHD(SOHD, MASP, SL)
VALUES ('1001', 'TV02', '10'),
	('1001', 'ST01', '5'),
	('1001', 'BC01', '5'),
	('1001', 'BC02', '10'),
	('1001', 'ST08', '10'),
	('1002', 'BC04', '20'),
	('1002', 'BB01', '20'),
	('1002', 'BB02', '20'),
	('1003', 'BB03', '10'),
	('1004', 'TV01', '20'),
	('1004', 'TV02', '10'),
	('1004', 'TV03', '10'),
	('1004', 'TV04', '10'),
	('1005', 'TV05', '50'),
	('1005', 'TV06', '50'),
	('1006', 'TV07', '20'),
	('1006', 'ST01', '30'),
	('1006', 'ST02', '10'),
	('1007', 'ST03', '10'),
	('1008', 'ST04', '8'),
	('1009', 'ST05', '10'),
	('1010', 'TV07', '50'),
	('1010', 'ST07', '50'),
	('1010', 'ST08', '100'),
	('1010', 'ST04', '50'),
	('1010', 'TV03', '100'),
	('1011', 'ST06', '50'),
	('1012', 'ST07', '3'),
	('1013', 'ST08', '5'),
	('1014', 'BC02', '80'),
	('1014', 'BB02', '100'),
	('1014', 'BC04', '60'),
	('1014', 'BB01', '50'),
	('1015', 'BB02', '30'),
	('1015', 'BB03', '7'),
	('1016', 'TV01', '5'),
	('1017', 'TV02', '1'),
	('1017', 'TV03', '1'),
	('1017', 'TV04', '5'),
	('1018', 'ST04', '6'),
	('1019', 'ST05', '1'),
	('1019', 'ST06', '2'),
	('1020', 'ST07', '10'),
	('1021', 'ST08', '5'),
	('1021', 'TV01', '7'),
	('1021', 'TV02', '10'),
	('1022', 'ST07', '1'),
	('1023', 'ST04', '6')

	-- CAU 2
SELECT * INTO SANPHAM1 FROM SANPHAM
SELECT * INTO KHACHHANG1 FROM KHACHHANG

-- CAU 3
UPDATE SANPHAM1 
SET GIA = GIA + GIA * 0.05
WHERE (NUOCSX = 'Thai Lan')

-- CAU 4
UPDATE SANPHAM1
SET GIA = GIA - GIA * 0.05
WHERE (NUOCSX = 'Trung Quoc' AND GIA < 10000)

-- CAU 5
UPDATE KHACHHANG1
SET LOAIKH = 'vip'
WHERE (NGDK < 1/1/2007 AND DOANHSO >= 10000000 OR NGDK >= 1/1/2007 AND DOANHSO >= 2000000) 

--PHAN 3
-- CAU 1
SELECT MASP, TENSP FROM SANPHAM WHERE (NUOCSX = 'Trung Quoc')

-- CAU 2
SELECT MASP, TENSP FROM SANPHAM WHERE (DVT = 'cay' OR DVT = 'quyen')

-- CAU 3
SELECT MASP, TENSP FROM SANPHAM WHERE (MASP LIKE 'B%01')
--C2: SELECT MASP, TENSP FROM SANPHAM WHERE (LEFT(MASP, 1) = 'B' AND RIGHT(MASP, 2) = '01')

-- CAU 4
SELECT MASP, TENSP FROM SANPHAM WHERE (NUOCSX = 'Trung Quoc' AND (GIA BETWEEN 30000 AND 40000))

-- CAU 5
SELECT MASP, TENSP FROM SANPHAM WHERE (NUOCSX = 'Trung Quoc' OR NUOCSX = 'Thai Lan' ) AND (GIA BETWEEN 30000 AND 40000)

-- CAU 6
SELECT SOHD, TRIGIA FROM HOADON WHERE (NGMH = '1/1/2007' OR NGMH = '2/1/2007')

-- CAU 7
SELECT SOHD, TRIGIA FROM HOADON WHERE (NGMH >= '1/1/2007' AND NGMH <= '1/1/2007') ORDER BY SOHD ASC, TRIGIA DESC

-- CAU 8
SELECT HD.MAKH, KH.HOTEN FROM HOADON HD, KHACHHANG KH WHERE (HD.NGMH = '1/1/2007' AND HD.MAKH = KH.MAKH)

-- CAU 9
SELECT HD.SOHD, HD.TRIGIA FROM HOADON HD, NHANVIEN NV WHERE (NGMH = '28/10/2006' AND HD.MANV = NV.MANV AND NV.HOTEN = 'NGUYEN VAN B')

-- CAU 10
SELECT DISTINCT CT.MASP, SP.TENSP FROM SANPHAM SP, KHACHHANG KH, HOADON HD, CTHD CT
WHERE ((HD.NGMH BETWEEN '1/10/2006' AND '31/10/2006') AND HD.MAKH = KH.MAKH AND CT.SOHD =  HD.SOHD AND KH.HOTEN = 'NGUYEN VAN A' AND CT.MASP = SP.MASP)

-- CAU 11
SELECT SOHD FROM CTHD  WHERE (MASP = 'BB01' OR MASP = 'BB02')

-- CAU 12
SELECT SOHD FROM CTHD WHERE (MASP = 'BB01' OR MASP = 'BB02') AND (SL BETWEEN 10 AND 20) 

-- CAU 13
SELECT A.SOHD FROM CTHD A 
WHERE A.MASP = 'BB01' AND A.SL BETWEEN 10 AND 20 
AND EXISTS (SELECT * FROM CTHD B WHERE B.MASP = 'BB02' AND SL BETWEEN 10 AND 20 AND A.SOHD = B.SOHD)

-- CAU 14
SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc'
UNION
SELECT SP.MASP, SP.TENSP FROM HOADON HD, SANPHAM SP, CTHD C 
WHERE HD.SOHD = C.SOHD AND HD.NGMH = '1/1/2007' AND C.MASP = SP.MASP

-- CAU 15
SELECT MASP, TENSP FROM SANPHAM
EXCEPT 
SELECT DISTINCT SP.MASP, SP.TENSP FROM CTHD C, SANPHAM SP WHERE SP.MASP = C.MASP

-- CAU 16
/*C1*/
SELECT MASP, TENSP FROM SANPHAM  WHERE NUOCSX = 'Trung Quoc'
EXCEPT
SELECT DISTINCT SP.MASP, SP.TENSP FROM HOADON HD, SANPHAM SP, CTHD C 
WHERE HD.SOHD = C.SOHD AND YEAR(HD.NGMH) = 2006 AND C.MASP = SP.MASP 
/*C2*/
SELECT MASP, TENSP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc' AND
MASP NOT IN (SELECT C.MASP FROM CTHD C, HOADON HD WHERE C.SOHD = HD.SOHD AND YEAR(HD.NGMH) = 2006)

-- CAU 17
SELECT MASP, TENSP FROM SANPHAM 
WHERE MASP NOT IN (SELECT C.MASP FROM CTHD C, HOADON HD WHERE C.SOHD = HD.SOHD AND YEAR(HD.NGMH) = 2006)
AND NUOCSX = 'Trung Quoc'

-- CAU 18
/*c1*/
SELECT SOHD FROM HOADON HD WHERE NOT EXISTS (SELECT * FROM SANPHAM SP WHERE NUOCSX = 'Singapore' 
AND NOT EXISTS (SELECT * FROM CTHD C WHERE C.MASP = SP.MASP AND HD.SOHD = C.SOHD))
/*c2*/
SELECT C.SOHD FROM CTHD C INNER JOIN SANPHAM SP ON C.MASP = SP.MASP 
WHERE SP.NUOCSX = 'Singapore' 
GROUP BY C.SOHD
HAVING COUNT(*) = (SELECT COUNT(*) FROM SANPHAM WHERE NUOCSX = 'Singapore')
/*c3*/
SELECT SOHD FROM HOADON HD WHERE NOT EXISTS (SELECT * FROM SANPHAM SP WHERE NUOCSX = 'Singapore'
AND SP.MASP NOT IN (SELECT MASP FROM CTHD C WHERE C.MASP = SP.MASP AND HD.SOHD = C.SOHD))

-- CAU 19
SELECT SOHD FROM HOADON HD WHERE YEAR(NGMH) = 2006 
AND NOT EXISTS (SELECT * FROM SANPHAM SP WHERE NUOCSX = 'Singapore'
AND NOT EXISTS (SELECT * FROM CTHD C WHERE C.MASP = SP.MASP AND HD.SOHD = C.SOHD))

-- CAU 20
SELECT  COUNT(DISTINCT HD.MAKH) AS SL FROM HOADON HD

-- CAU 21
SELECT COUNT (DISTINCT C.MASP) AS SL FROM CTHD C, HOADON HD
WHERE C.SOHD = HD.SOHD AND YEAR(HD.NGMH) = 2006

-- CAU 22
-- TRI GIA HOA DON CAO NHAT
SELECT TOP 1 SOHD, TRIGIA AS MAXTRIGIA FROM HOADON ORDER BY TRIGIA DESC
-- TRI GIA HOA DON THAP NHAT
SELECT TOP 1 SOHD, TRIGIA AS MINTRIGIA FROM HOADON ORDER BY TRIGIA ASC

-- CAU 23
SELECT AVG(TRIGIA) AS TRIGIATB2006 FROM HOADON WHERE YEAR(NGMH) = 2006

-- CAU 24
SELECT SUM(TRIGIA) AS DOANHTHU FROM HOADON WHERE YEAR(NGMH) = 2006

-- CAU 25
SELECT TOP 1 SOHD, TRIGIA FROM HOADON WHERE YEAR(NGMH) = 2006 ORDER BY TRIGIA DESC

-- CAU 26 
SELECT TOP 1 KH.HOTEN FROM HOADON HD INNER JOIN KHACHHANG KH ON HD.MAKH = KH.MAKH
WHERE YEAR(HD.NGMH) = 2006 ORDER BY TRIGIA DESC

-- CAU 27
SELECT TOP 3 MAKH, HOTEN FROM KHACHHANG ORDER BY DOANHSO DESC

-- CAU 28
SELECT MASP, TENSP FROM SANPHAM 
WHERE MASP IN ( SELECT TOP 3 MASP FROM SANPHAM ORDER BY GIA DESC)

-- CAU 29
SELECT MASP, TENSP FROM SANPHAM 
WHERE NUOCSX = 'Thai Lan' AND MASP IN ( SELECT TOP 3 MASP FROM SANPHAM ORDER BY GIA DESC)

-- CAU 30
SELECT MASP, TENSP FROM SANPHAM 
WHERE NUOCSX = 'Trung Quoc' AND MASP IN ( SELECT TOP 3 MASP FROM SANPHAM WHERE NUOCSX = 'Trung Quoc' ORDER BY GIA DESC)

-- *CAU 31
SELECT TOP 3 WITH TIES MAKH, HOTEN FROM KHACHHANG ORDER BY DOANHSO DESC

-- CAU 32
SELECT COUNT(MASP) AS SOLUONGSPDOTRUNGQUOCSX FROM SANPHAM WHERE NUOCSX = 'Trung Quoc'

-- CAU 33
SELECT NUOCSX, COUNT(MASP) AS SOLUONGSPTUNGNUOC FROM SANPHAM 
GROUP BY NUOCSX

-- CAU 34
SELECT NUOCSX, COUNT(MASP) AS SOLUONGSPTUNGNUOC, MAX(GIA) AS GIAMAX, MIN(GIA) AS GIAMIN, AVG(GIA) AS GIATB FROM SANPHAM 
GROUP BY NUOCSX

-- CAU 35
SELECT NGMH, SUM(TRIGIA) AS DOANHTHU FROM HOADON 
GROUP BY NGMH

-- CAU 36
SELECT MASP, SUM(SL) AS SOLUONG FROM CTHD SP INNER JOIN HOADON HD ON SP.SOHD = HD.SOHD
WHERE MONTH(HD.NGMH) = 10 AND YEAR(HD.NGMH) = 2006 
GROUP BY MASP

-- CAU 37
SELECT MONTH(NGMH) AS THANG, SUM(TRIGIA) AS DOANHTHU FROM HOADON 
WHERE YEAR(NGMH) = 2006
GROUP BY MONTH(NGMH)

-- CAU 38
SELECT SOHD FROM CTHD
GROUP BY SOHD
HAVING COUNT(*) >= 4

-- CAU 39
SELECT SOHD FROM SANPHAM SP, CTHD C
WHERE SP.MASP = C.MASP AND SP.NUOCSX = 'Viet Nam'
GROUP BY SOHD
HAVING COUNT(*) = 3

-- CAU 40
SELECT TOP 1 WITH TIES KH.MAKH, KH.HOTEN FROM KHACHHANG KH, HOADON HD
WHERE KH.MAKH = HD.MAKH 
GROUP BY KH.MAKH, KH.HOTEN
ORDER BY COUNT(SOHD) DESC

-- CAU 41
SELECT TOP 1 MONTH(NGMH) AS THANG FROM HOADON WHERE YEAR(NGMH) = 2006
GROUP BY MONTH(NGMH) 
ORDER BY SUM(TRIGIA) DESC

-- CAU 42
SELECT TOP 1 SP.TENSP, SP.MASP FROM CTHD C INNER JOIN SANPHAM SP ON C.MASP = SP.MASP	
INNER JOIN HOADON HD ON C.SOHD = HD.SOHD
WHERE YEAR(HD.NGMH) = 2006
GROUP BY SP.TENSP, SP.MASP
ORDER BY SUM(SL) ASC

-- *CAU 43
SELECT NUOCSX, TENSP, MASP FROM SANPHAM SP
GROUP BY NUOCSX, TENSP, MASP
HAVING MAX(GIA) = (SELECT MAX(GIA) FROM SANPHAM SP1 GROUP BY NUOCSX HAVING SP.NUOCSX = SP1.NUOCSX)

-- CAU 44 
SELECT NUOCSX FROM SANPHAM
GROUP BY NUOCSX
HAVING COUNT(MASP) >= 3 AND COUNT(DISTINCT GIA) = COUNT(MASP) 

-- CAU 45
SELECT KH.MAKH, KH.HOTEN, KH.DOANHSO FROM KHACHHANG KH INNER JOIN HOADON HD ON KH.MAKH = HD.MAKH
GROUP BY KH.MAKH, KH.HOTEN, KH.DOANHSO
HAVING COUNT(HD.SOHD) >= ALL (SELECT COUNT(HD1.SOHD) FROM KHACHHANG KH1 INNER JOIN HOADON HD1 ON KH1.MAKH = HD1.MAKH 
GROUP BY KH1.MAKH)
INTERSECT
SELECT TOP 10 MAKH, HOTEN, DOANHSO FROM KHACHHANG ORDER BY DOANHSO DESC


